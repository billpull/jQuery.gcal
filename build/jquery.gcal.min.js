/*! jquery.gcal version: 0.0.1
*  2013-02-25
*  Author: Bill Pullen
*  Website: http://billpull.github.com/knockout-bootstrap
*  MIT License http://www.opensource.org/licenses/mit-license.php
*/
(function(e){var t={gcalFeedData:{},gcalEvents:{},monthDict:{0:"JAN",1:"FEB",2:"MAR",3:"APR",4:"MAY",5:"JUN",6:"JUL",7:"AUG",8:"SEP",9:"OCT",10:"NOV",11:"DEC"},pad2:function(e){return(10>e?"0":"")+e},monthNames:["January","February","March","April","May","June","July","August","September","October","November","December"],dayNames:["Sun","Mon","Tue","Wed","Thu","Fri","Sat"]};e.fn.gcalFeed=function(a,n){var r=e(this),c="<li class='gc-loading'>							<div class='alert clearfix'>								<span class='gc-loading-txt'>Loading...</span>								<span class='gc-loading-img'></span>							</div>						  </li>",i="<div id='gc-month-control'>								<h3 id='gc-month-year-str'><%= date_string =%></h3>								<div id='gc-month-controls'>									<div class='btn-group'>										<button class='btn' id='gc-today-btn'>Today</button>										<button class='btn' id='gc-month-decrease'>&lt;</button>										<button class='btn' id='gc-month-increase'>&gt;</button>									</div>								</div>							</div>							<div>								<div class='event_shadow'></div>							</div>",d="<p><b>When:</b>&nbsp;<%= event_time %=></p>							 <p><b>Where:</b>&nbsp;<%= event_location %=>&nbsp							 	<a target='_blank' href='http://maps.google.com/maps?q=<%= event_location_url %=>&hl=en'>map</a>							 </p>							 <p><b>Description:</b> <%= event_desc %=></p>",o=e("<div />",{"class":"row gc-cal-feed-wrap"}).appendTo(r);e("<ul/>",{id:"gc-event-list-wrap","class":"gc-event-list"}).appendTo(o);var s=e("#gc-event-list-wrap");r.append('<div class="event_shadow_btm"></div>');var l=RegExp(/^(http|https):\/\/www.google.com\/calendar\/feeds\//),m=function(e){var a='<li class="active gc-event-item clearfix" data-event-id="'+e.calId+'">';return a+='<div class="gc-event-date">',a+='<span class="gc-event-day">'+e.day+"</span>",a+='<span class="gc-event-month">'+t.monthDict[e.month]+"</span>",a+="</div>",a+='<div class="gc-event-title">',a+=e.title+"<br>"+e.where,a+="</li>"},v=function(e){if(s.html(""),e.length>0)for(var a=0;e.length>a;a++){var n=e[a],r=n.gd$when[0].startTime,c=n.title.$t,i=n.gd$where[0].valueString,d=n.gCal$uid.value;c.length>31&&(c=c.substring(0,28)+"..."),i.length>31&&(i=i.substring(0,28)+"..."),t.gcalFeedData[d]=n;var o=new Date(r),l={calId:d,day:t.pad2(o.getDate()),month:o.getMonth(),title:c,where:i},v=m(l);s.append(v)}else{var g='<li id="gc-no-events"><div class="alert">No Events This Month</div></li>';s.append(g)}},g=function(e){var a=e.feed.entry;a||(a=[]),t.gcalEvents[Y["start-min"]]=a,v(a)},p=moment(),u=function(e){var t=e.subtract("d",1);return t.format("YYYY-MM-DD")+"T00:00:00"},h=function(e){var t=e.add("d",1);return t.format("YYYY-MM-DD")+"T23:59:59"},f=function(e,t){var a=moment(e.format("YYYY-MM-DD")),n=moment(t.format("YYYY-MM-DD")),r=a.isSame(n),c="";return r?(c+=e.format("ddd, MMMM Do YYYY, h:mma"),c+=" - "+t.format("h:mma")):(c+=e.format("ddd, MMMM Do YYYY, h:mma"),c+=" - "+t.format("ddd, MMMM Do YYYY, h:mma")),c},b={ctz:"",fields:"",futureevents:!1,"max-attendees":"","max-results":9999,orderby:"starttime","recurrence-expansion-start":"","recurrence-expansion-end":"",singleevents:!0,showdeleted:!1,showhidden:!1,sortorder:"ascending","start-min":u(p),"start-max":h(p),"updated-min":"",callback:g},Y=e.extend(b,n);""!==a||a.match(l)||window.alert("Incorrect Google Calendar Feed Url"),a=a.replace(/\/basic$/,"/full")+"?alt=json-in-script&callback=?",Y.ctz&&(Y.ctz=Y.ctz.replace(" ","_"));var M=Y.callback;delete Y.callback;for(key in Y)Y[key]||delete Y[key];var w=function(){var n=t.gcalEvents[Y["start-min"]];if(n==[]||void 0===n){var r=e.ajax({url:a,dataType:"jsonp",data:Y,startParam:!1,endParam:!1});r.done(function(e){M(e)})}else v(n)},D=function(e){var t=e.format("MMMM"),a=e.format("YYYY"),n=t+" "+a;return n},y=function(){s.html(""),s.append(c)},_=function(t){y();var a=moment(new Date(Y["start-min"])).add("d",1).add("M",t);Y["start-min"]=u(a),Y["start-max"]=h(a),e("#gc-month-year-str").text(D(a)),w()},x=function(){var a=moment(new Date(Y["start-min"])).add("d",1),n=D(a),c=i.replace("<%= date_string =%>",n);r.prepend(c),y(),w(),e("#gc-month-decrease").click(function(){_(-1)}),e("#gc-month-increase").click(function(){_(1)}),e("#gc-today-btn").click(function(){y(),Y["start-min"]=u(p),Y["start-max"]=h(p),e("#gc-month-year-str").text(D(p)),w()}),e(document).on("click",".gc-event-item",function(){var a=e(this).data("event-id"),n=t.gcalFeedData[a];if(n){var r=n.title.$t,c=moment(new Date(n.gd$when[0].startTime)),i=moment(new Date(n.gd$when[0].endTime)),o=n.gd$where[0].valueString,s=encodeURIComponent(o);n.content.$t;var l=n.link[0].href;e("#gc-event-modal-header").text(r),eventTimeStr=f(c,i);var m=d.replace("<%= event_time %=>",eventTimeStr).replace("<%= event_location %=>",o).replace("<%= event_location_url %=>",s).replace("<%= event_desc %=>",n.content.$t);e("#gc-event-modal-body").html(m),e("#gc-event-modal-link").attr("href",l),e("#gc-event-modal").modal()}})};x()}})(jQuery);