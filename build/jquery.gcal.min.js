/*! jquery.gcal version: 0.0.1
*  2013-02-25
*  Author: Bill Pullen
*  Website: http://billpull.github.com/knockout-bootstrap
*  MIT License http://www.opensource.org/licenses/mit-license.php
*/
(function(e){var t={gcalFeedData:{},gcalEvents:{},monthDict:{0:"JAN",1:"FEB",2:"MAR",3:"APR",4:"MAY",5:"JUN",6:"JUL",7:"AUG",8:"SEP",9:"OCT",10:"NOV",11:"DEC"},pad2:function(e){return(10>e?"0":"")+e},monthNames:["January","February","March","April","May","June","July","August","September","October","November","December"],dayNames:["Sun","Mon","Tue","Wed","Thu","Fri","Sat"]};e.fn.gcalFeed=function(n,a){var r=e(this),c="<li class='gc-loading'>							<div class='alert clearfix'>								<span class='gc-loading-txt'>Loading...</span>								<span class='gc-loading-img'></span>							</div>						  </li>",i="<div id='gc-month-control' class='row'>								<div class='span3'>									<h3 id='gc-month-year-str'><%= date_string =%></h3>								</div>								<div class='span2 clearfix' id='gc-month-controls'>									<button class='btn' id='gc-today-btn'>Today</button>									<div class='btn-group'>										<button class='btn' id='gc-month-decrease'>&lt;</button>										<button class='btn' id='gc-month-increase'>&gt;</button>									</div>								</div>							</div>							<div class='row'>								<div class='event_shadow'></div>							</div>",s="<p><b>When:</b>&nbsp;<%= event_time %=></p>							 <p><b>Where:</b>&nbsp;<%= event_location %=>&nbsp							 	<a target='_blank' href='http://maps.google.com/maps?q=<%= event_location_url %=>&hl=en'>map</a>							 </p>							 <p><b>Description:</b> <%= event_desc %=></p>",l=e("<div />",{"class":"row gc-cal-feed-wrap"}).appendTo(r);e("<ul/>",{id:"gc-event-list-wrap","class":"gc-event-list"}).appendTo(l);var o=e("#gc-event-list-wrap");r.append('<div class="event_shadow_btm"></div>');var d=RegExp(/^(http|https):\/\/www.google.com\/calendar\/feeds\//),v=function(e){var n='<li class="active gc-event-item clearfix" data-event-id="'+e.calId+'">';return n+='<div class="gc-event-date">',n+='<span class="gc-event-day">'+e.day+"</span>",n+='<span class="gc-event-month">'+t.monthDict[e.month]+"</span>",n+="</div>",n+='<div class="gc-event-title">',n+=e.title+"<br>"+e.where,n+="</li>"},g=function(e){if(o.html(""),e.length>0)for(var n=0;e.length>n;n++){var a=e[n],r=a.gd$when[0].startTime,c=a.title.$t,i=a.gd$where[0].valueString,s=a.gCal$uid.value;c.length>31&&(c=c.substring(0,28)+"..."),i.length>31&&(i=i.substring(0,28)+"..."),t.gcalFeedData[s]=a;var l=new Date(r),d={calId:s,day:t.pad2(l.getDate()),month:l.getMonth(),title:c,where:i},g=v(d);o.append(g)}else{var u='<li id="gc-no-events"><div class="alert">No Events This Month</div></li>';o.append(u)}},u=function(e){var n=e.feed.entry;n||(n=[]),t.gcalEvents[_["start-min"]]=n,g(n)},m=new Date,p=function(e){var n=e.getUTCMonth()+1,a=e.getUTCFullYear(),r=e.getUTCDate(),c=""+a+"-"+(""+t.pad2(n))+"-"+(""+t.pad2(r));return c},h=function(e){var t=new Date(e.getFullYear(),e.getMonth(),1);return p(t)+"T00:00:00"},f=function(e){var t=new Date(e.getFullYear(),e.getMonth()+1,0);return p(t)+"T23:59:59"},b=function(e){return 0===e?12:e>12?e-12:e},w=function(e){return e>12?"pm":"am"},y=function(e){var n=b(e.getHours()),a=w(e.getHours()),r=n+":"+t.pad2(e.getMinutes())+a;return r},D=function(e){var n=t.dayNames[e.getDay()],a=t.monthNames[e.getMonth()],r=n+", "+a+" "+e.getDate()+", ",c=y(e);return r+=c},T=function(e,t){var n=e.getMonth(),a=e.getDate(),r=t.getMonth(),c=t.getDate(),i=n+"-"+a,s=r+"-"+c;if(i===s){var l=D(e),o=y(t);return l+=" - "+o}var l=D(e),d=D(t);return l+" - "+d},x={ctz:"",fields:"",futureevents:!1,"max-attendees":"","max-results":9999,orderby:"starttime","recurrence-expansion-start":"","recurrence-expansion-end":"",singleevents:!0,showdeleted:!1,showhidden:!1,sortorder:"ascending","start-min":h(m),"start-max":f(m),"updated-min":"",callback:u},_=e.extend(x,a);if(""===n&&!n.match(d))throw"Incorrect Google Calendar Feed Url";n=n.replace(/\/basic$/,"/full")+"?alt=json-in-script&callback=?",_.ctz&&(_.ctz=_.ctz.replace(" ","_"));var M=_.callback;delete _.callback;for(key in _)_[key]||delete _[key];var k=function(){var a=t.gcalEvents[_["start-min"]];if(a==[]||void 0===a){var r=e.ajax({url:n,dataType:"jsonp",data:_,startParam:!1,endParam:!1});r.done(function(e){M(e)}),r.fail(function(e){throw e})}else g(a)},F=function(e){var n=t.monthNames[e.getMonth()],a=e.getFullYear(),r=n+" "+a;return r},$=function(){o.html(""),o.append(c)},N=function(t){$();var n=new Date(_["start-min"]).add(1).days().add(t).months();_["start-min"]=h(n),_["start-max"]=f(n),e("#gc-month-year-str").text(F(n)),k()},C=function(){var n=new Date(_["start-min"]).add(1).days(),a=F(n),c=i.replace("<%= date_string =%>",a);r.prepend(c),$(),k(),e("#gc-month-decrease").click(function(){N(-1)}),e("#gc-month-increase").click(function(){N(1)}),e("#gc-today-btn").click(function(){$(),_["start-min"]=h(m),_["start-max"]=f(m),e("#gc-month-year-str").text(F(m)),k()}),e(document).on("click",".gc-event-item",function(){var n=e(this).data("event-id"),a=t.gcalFeedData[n];if(a){var r=a.title.$t,c=new Date(a.gd$when[0].startTime),i=new Date(a.gd$when[0].endTime),l=a.gd$where[0].valueString,o=encodeURIComponent(l);a.content.$t;var d=a.link[0].href;e("#gc-event-modal-header").text(r),eventTimeStr=T(c,i);var v=s.replace("<%= event_time %=>",eventTimeStr).replace("<%= event_location %=>",l).replace("<%= event_location_url %=>",o).replace("<%= event_desc %=>",a.content.$t);e("#gc-event-modal-body").html(v),e("#gc-event-modal-link").attr("href",d),e("#gc-event-modal").modal()}})};C()}})(jQuery);